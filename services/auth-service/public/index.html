<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign in to WolfeUp</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: #161b22;
      --card-border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --input-bg: #0d1117;
      --input-border: #30363d;
      --btn: #21262d;
      --btn-hover: #30363d;
      --btn-border: #30363d;
      --primary: #2f81f7;
      --primary-hover: #1f6feb;
      --success-bg: #0f2419;
      --success-border: #1f6f43;
      --success-text: #7ee787;
      --error-bg: #2d1016;
      --error-border: #8b2635;
      --error-text: #ffb3ba;
      --radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      display: grid;
      place-items: center;
      padding: 24px 16px;
    }
    .shell { width: 100%; max-width: 340px; display: grid; gap: 16px; }
    .brand { text-align: center; font-size: 22px; font-weight: 600; letter-spacing: .2px; }
    .title { text-align: center; font-size: 24px; font-weight: 300; margin: 0; color: var(--text); }
    .card { background: var(--card); border: 1px solid var(--card-border); border-radius: var(--radius); padding: 16px; display: grid; gap: 10px; }
    .muted { margin: 0; color: var(--muted); font-size: 12px; text-align: center; }
    .status { margin: 0; border: 1px solid; border-radius: 6px; padding: 10px; font-size: 13px; }
    .status.ok { background: var(--success-bg); border-color: var(--success-border); color: var(--success-text); }
    .status.err { background: var(--error-bg); border-color: var(--error-border); color: var(--error-text); }
    .btn, input { width: 100%; border-radius: 6px; border: 1px solid var(--btn-border); padding: 9px 12px; font: inherit; }
    .btn { cursor: pointer; background: var(--btn); color: var(--text); font-weight: 500; transition: background-color .12s ease, border-color .12s ease; }
    .btn:hover { background: var(--btn-hover); }
    .btn.primary { background: var(--primary); border-color: rgba(240, 246, 252, 0.1); color: #fff; }
    .btn.primary:hover { background: var(--primary-hover); }
    .btn.apple { background: #000; border-color: #262626; color: #fff; }
    .btn.apple:hover { background: #111; }
    .btn:disabled { opacity: .7; cursor: not-allowed; }
    .divider { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 10px; color: var(--muted); font-size: 12px; margin: 2px 0; }
    .divider::before,.divider::after { content: ""; height: 1px; background: var(--card-border); }
    label { display: block; margin-bottom: 6px; color: var(--text); font-size: 12px; font-weight: 500; }
    input { background: var(--input-bg); border-color: var(--input-border); color: var(--text); outline: none; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(47, 129, 247, .22); }
    .field { margin-bottom: 10px; }
    .footer { text-align: center; font-size: 12px; color: var(--muted); }
  </style>
</head>
<body>
  <main class="shell" aria-label="WolfeUp sign in">
    <div class="brand">WolfeUp</div>
    <h1 class="title">Sign in to WolfeUp</h1>

    <section class="card" aria-label="Sign in methods">
      <p id="status" aria-live="polite"></p>

      <button id="btn-google" class="btn" type="button">Sign in with Google</button>
      <button id="btn-apple" class="btn apple" type="button">Sign in with Apple</button>
      <p class="muted">Sign in with Google or Apple. Email/password works below.</p>

      <div class="divider">or</div>

      <form id="password-form" novalidate>
        <div class="field">
          <label for="email">Email address</label>
          <input id="email" type="email" autocomplete="email username" placeholder="name@example.com" required />
        </div>

        <div class="field">
          <label for="password">Password</label>
          <input id="password" type="password" autocomplete="current-password" required />
        </div>

        <button id="btn-password" type="submit" class="btn primary">Sign in</button>
      </form>
    </section>

    <p class="footer">Secure sign-in powered by Google + Apple OAuth</p>
  </main>

  <script>
    const statusEl = document.getElementById('status');
    const btnGoogle = document.getElementById('btn-google');
    const btnApple = document.getElementById('btn-apple');
    const form = document.getElementById('password-form');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const btnPassword = document.getElementById('btn-password');

    function setStatus(message = '', type = 'ok') {
      if (!message) {
        statusEl.className = '';
        statusEl.textContent = '';
        statusEl.style.display = 'none';
        return;
      }
      statusEl.style.display = 'block';
      statusEl.className = `status ${type === 'err' ? 'err' : 'ok'}`;
      statusEl.textContent = message;
    }

    function setBusy(isBusy) {
      [btnGoogle, btnApple, btnPassword].forEach(btn => { btn.disabled = isBusy; });
    }

    async function api(path, options = {}) {
      const res = await fetch(path, {
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
        ...options,
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json.error || `Request failed (${res.status})`);
      return json;
    }

    async function isAppleConfigured() {
      try {
        const res = await fetch('/auth/apple', { method: 'GET', credentials: 'include', redirect: 'manual' });
        if (res.status === 503) {
          setStatus('Apple sign-in is not configured yet. Please use Google or email/password for now.', 'err');
          return false;
        }
        return true;
      } catch (_) {
        setStatus('Could not start Apple sign-in right now. Please use Google or email/password.', 'err');
        return false;
      }
    }

    btnGoogle.addEventListener('click', () => {
      setStatus('Redirecting to Google...');
      window.location.href = '/auth/google';
    });

    btnApple.addEventListener('click', async () => {
      setStatus('');
      setBusy(true);
      const appleReady = await isAppleConfigured();
      if (!appleReady) {
        setBusy(false);
        return;
      }
      window.location.href = '/auth/apple';
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      setStatus('');

      const username = emailEl.value.trim().toLowerCase();
      const password = passEl.value;

      if (!username || !password) {
        setStatus('Enter both email and password.', 'err');
        return;
      }

      setBusy(true);
      setStatus('Signing in...');

      try {
        await api('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ username, password }),
        });

        setStatus('Signed in. Redirecting...');
        setTimeout(() => { window.location.href = '/profile.html'; }, 300);
      } catch (_) {
        try {
          const local = username
            .split('@')[0]
            .replace(/[^a-z0-9_.-]/g, '')
            .slice(0, 24) || `user${Date.now().toString(36).slice(-4)}`;
          const unique = `${local}_${Math.floor(Math.random() * 9000 + 1000)}`;

          await api('/auth/register', {
            method: 'POST',
            body: JSON.stringify({
              username: unique,
              email: username,
              password,
              display_name: local,
            }),
          });

          setStatus('Account created and signed in. Redirecting...');
          setTimeout(() => { window.location.href = '/profile.html?welcome=1'; }, 300);
        } catch (err) {
          setStatus(err.message || 'Could not sign in', 'err');
        }
      } finally {
        setBusy(false);
      }
    });

    setStatus('');
  </script>
</body>
</html>
