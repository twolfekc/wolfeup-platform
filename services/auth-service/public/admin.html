<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äî WolfeUp Auth</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0f1117;
      --surface: #161b27;
      --surface2: #1e2636;
      --surface3: #242d3e;
      --border: #2a3347;
      --border2: #3a4560;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --muted2: #64748b;
      --accent: #6366f1;
      --accent-h: #818cf8;
      --accent-d: #4f46e5;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --sync: #0ea5e9;
      --r: 10px;
      --rs: 6px;
    }

    html, body {
      height: 100%;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.45;
    }

    .app { min-height: 100vh; display: flex; flex-direction: column; }

    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      height: 60px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo { display: flex; align-items: center; gap: 9px; text-decoration: none; color: inherit; }
    .logo-icon {
      width: 32px; height: 32px; border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-d));
      display: grid; place-items: center; font-size: 16px;
    }
    .logo-text { font-size: 16px; font-weight: 700; }
    .logo-text span { color: var(--accent-h); }

    .pill {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .5px;
      font-weight: 600;
      color: var(--accent-h);
      background: rgba(99,102,241,.16);
      border: 1px solid rgba(99,102,241,.35);
      border-radius: 999px;
      padding: 4px 9px;
    }

    .header-right { margin-left: auto; display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 12px; }
    .health-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--muted2);
      box-shadow: 0 0 0 0 rgba(34,197,94,0.4);
      transition: background .2s ease, box-shadow .2s ease;
    }
    .health-dot.online {
      background: var(--success);
      box-shadow: 0 0 0 6px rgba(34,197,94,0.12);
    }
    .health-dot.offline {
      background: var(--danger);
      box-shadow: 0 0 0 6px rgba(239,68,68,0.12);
    }

    .stats {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 18px 24px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    }

    .stat-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 14px;
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 3px;
      background: var(--accent);
    }
    .stat-label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; font-weight: 600; }
    .stat-value { margin-top: 6px; font-size: 30px; font-weight: 700; line-height: 1; letter-spacing: -.8px; }
    .stat-sub { margin-top: 4px; color: var(--muted2); font-size: 11px; }

    .main { max-width: 1400px; width: 100%; margin: 0 auto; padding: 24px; }
    .section { margin-bottom: 26px; }
    .section-head { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .section-title { font-size: 15px; font-weight: 600; }
    .count { font-size: 12px; color: var(--muted); border: 1px solid var(--border); background: var(--surface2); border-radius: 999px; padding: 2px 9px; }
    .section-actions { margin-left: auto; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 18px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .4px; font-weight: 600; }
    input[type="text"], input[type="email"], input[type="password"] {
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      border-radius: var(--rs);
      padding: 10px 12px;
      outline: none;
      font-size: 13px;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,.14);
    }

    .btn {
      border: none;
      border-radius: var(--rs);
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      display: inline-flex;
      align-items: center;
      gap: 7px;
    }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    .btn-primary {
      color: white;
      background: linear-gradient(135deg, var(--accent), var(--accent-d));
      box-shadow: 0 2px 10px rgba(99,102,241,.28);
    }
    .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, var(--accent-h), var(--accent)); }
    .btn-secondary {
      color: var(--text);
      background: var(--surface2);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) { border-color: var(--border2); }
    .btn-danger {
      color: #fecaca;
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.27);
    }
    .btn-danger:hover:not(:disabled) { background: rgba(239,68,68,.2); }
    .btn-sm { padding: 5px 10px; font-size: 12px; font-weight: 500; }

    .alert {
      display: none;
      margin-bottom: 12px;
      padding: 9px 12px;
      border-radius: var(--rs);
      border: 1px solid transparent;
      font-size: 13px;
    }
    .alert.show { display: block; }
    .alert-error { color: #fecaca; background: rgba(239,68,68,.1); border-color: rgba(239,68,68,.3); }
    .alert-success { color: #86efac; background: rgba(34,197,94,.1); border-color: rgba(34,197,94,.3); }
    .alert-info { color: #c7d2fe; background: rgba(99,102,241,.1); border-color: rgba(99,102,241,.3); }

    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead tr { background: var(--surface2); border-bottom: 1px solid var(--border); }
    th {
      padding: 9px 12px;
      text-align: left;
      color: var(--muted);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .5px;
      white-space: nowrap;
    }
    td { padding: 11px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }

    tr.user-row { transition: background .15s ease; }
    tr.user-row:hover { background: var(--surface2); }
    tr.user-row.expanded { background: var(--surface2); }

    .avatar {
      width: 30px; height: 30px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-d));
      color: white; display: grid; place-items: center;
      font-weight: 700; font-size: 12px;
      flex-shrink: 0;
    }

    .user-cell { display: flex; align-items: center; gap: 9px; }
    .username { font-weight: 600; }
    .email-sub { color: var(--muted); font-size: 11px; }

    .pk-badge, .none-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      font-weight: 600;
    }
    .pk-badge { color: var(--accent-h); background: rgba(99,102,241,.13); border: 1px solid rgba(99,102,241,.3); }
    .none-badge { color: var(--muted2); background: var(--surface2); border: 1px solid var(--border); }

    .expand-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 12px;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: background .15s ease, color .15s ease;
      white-space: nowrap;
    }
    .expand-btn:hover { background: var(--border); color: var(--text); }
    .expand-btn .arrow { transition: transform .2s ease; }
    .expand-btn.open .arrow { transform: rotate(90deg); }

    .sub-row td {
      background: var(--surface3);
      padding: 0;
      border-bottom: 1px solid var(--border);
    }

    .sub-inner {
      max-height: 0;
      overflow: hidden;
      transition: max-height .25s ease;
      will-change: max-height;
    }
    .sub-inner.open { max-height: 1200px; }

    .passkeys-pane { padding: 12px 14px 14px 46px; }
    .passkeys-head { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; font-weight: 600; margin-bottom: 9px; }

    .passkey-item {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--rs);
      padding: 10px;
      display: grid;
      grid-template-columns: minmax(160px, 1.2fr) minmax(180px, 1fr) minmax(180px, 1fr) auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 7px;
      transition: border-color .15s ease, transform .1s ease;
    }
    .passkey-item:hover { border-color: var(--border2); }
    .passkey-item:last-child { margin-bottom: 0; }

    .pk-device-wrap { display: flex; flex-direction: column; gap: 6px; min-width: 0; }
    .pk-device-line { display: flex; align-items: center; gap: 8px; min-width: 0; }

    .pk-name-input {
      width: 100%;
      min-width: 0;
      background: rgba(15,17,23,.5);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 7px 9px;
      font-size: 12px;
    }
    .pk-name-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,.14);
      outline: none;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: var(--muted);
      background: rgba(15,17,23,.42);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 2px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      display: inline-block;
    }

    .pk-meta { font-size: 11px; color: var(--muted); }
    .meta-col { min-width: 0; }

    .status-badge {
      font-size: 11px;
      font-weight: 600;
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .status-synced { color: #7dd3fc; border: 1px solid rgba(14,165,233,.35); background: rgba(14,165,233,.14); }
    .status-notsynced { color: #fcd34d; border: 1px solid rgba(245,158,11,.35); background: rgba(245,158,11,.14); }

    .empty {
      text-align: center;
      color: var(--muted2);
      padding: 38px 18px;
    }

    .spinner {
      width: 13px;
      height: 13px;
      border: 2px solid rgba(255,255,255,.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .full-error {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
      background: radial-gradient(circle at 20% 0%, rgba(99,102,241,.12), transparent 35%), var(--bg);
    }
    .full-error-card {
      text-align: center;
      max-width: 560px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 26px;
    }
    .full-error h1 { font-size: 24px; margin-bottom: 8px; }
    .full-error p { color: var(--muted); }

    @media (max-width: 1050px) {
      .passkey-item {
        grid-template-columns: 1fr;
        align-items: stretch;
      }
    }

    @media (max-width: 800px) {
      .header, .stats, .main { padding-left: 14px; padding-right: 14px; }
      th:nth-child(3), td:nth-child(3), th:nth-child(4), td:nth-child(4) { display: none; }
      .passkeys-pane { padding-left: 14px; }
    }
  </style>
</head>
<body>
<div class="app" id="app" style="display:none;">
  <header class="header">
    <a href="/" class="logo">
      <div class="logo-icon">üê∫</div>
      <div class="logo-text">Wolfe<span>Up</span></div>
    </a>
    <div class="pill">Auth Admin</div>

    <div class="header-right">
      <div id="health-dot" class="health-dot"></div>
      <span id="health-text">Health: checking‚Ä¶</span>
      <span>‚Ä¢</span>
      <span id="last-updated">Last updated 0s ago</span>
    </div>
  </header>

  <section class="stats">
    <div class="stat-card">
      <div class="stat-label">Total Users</div>
      <div class="stat-value" id="stat-users">‚Äî</div>
      <div class="stat-sub">registered accounts</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Passkeys</div>
      <div class="stat-value" id="stat-passkeys">‚Äî</div>
      <div class="stat-sub">enrolled credentials</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Active Sessions</div>
      <div class="stat-value" id="stat-sessions">‚Äî</div>
      <div class="stat-sub">currently live</div>
    </div>
  </section>

  <main class="main">
    <section class="section">
      <div class="section-head">
        <div class="section-title">Add User</div>
      </div>
      <div class="card">
        <div class="alert" id="add-alert"></div>
        <form id="add-form">
          <div class="form-grid">
            <div class="field">
              <label for="add-username">Username</label>
              <input id="add-username" type="text" required placeholder="newuser" />
            </div>
            <div class="field">
              <label for="add-email">Email</label>
              <input id="add-email" type="email" required placeholder="user@example.com" />
            </div>
            <div class="field">
              <label for="add-password">Password</label>
              <input id="add-password" type="password" required placeholder="Strong password" />
            </div>
          </div>
          <button id="add-submit" class="btn btn-primary" type="submit">Add User</button>
        </form>
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <div class="section-title">Users</div>
        <div class="count" id="user-count">‚Äî</div>
        <div class="section-actions">
          <button class="btn btn-secondary" id="refresh-users" type="button">‚Ü∫ Refresh</button>
        </div>
      </div>

      <div class="alert" id="users-alert"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Username</th>
              <th>Email</th>
              <th>Joined</th>
              <th>Last Login</th>
              <th>Passkeys</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-body">
            <tr><td colspan="7"><div class="empty">Loading users‚Ä¶</div></td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
  const AAGUID_NAMES = {
    'fbfc3007-154e-4ecc-8c0b-6e020557d7bd': 'iCloud Keychain',
    '531126d6-e717-415c-9b90-82db8caf084a': 'Windows Hello',
    'adce0002-35bc-c60a-648b-0b25f1f05503': 'Chrome on Mac',
    'bada5566-a7aa-401f-b6a2-b87b0dbc07f2': 'Chrome on Android',
  };

  const $ = (id) => document.getElementById(id);

  let users = [];
  const expanded = new Set();
  let lastDataUpdateAt = Date.now();

  function esc(str) {
    return String(str ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function formatDate(ts) {
    if (!ts) return '<span style="color:var(--muted2)">‚Äî</span>';
    const d = new Date(Number(ts) * 1000 || ts);
    if (Number.isNaN(d.getTime())) return '<span style="color:var(--muted2)">‚Äî</span>';
    return `${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} <span style="color:var(--muted2)">${d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span>`;
  }

  function initials(name) {
    const n = (name || '?').trim();
    return n ? n[0].toUpperCase() : '?';
  }

  function showAlert(id, msg, type = 'error') {
    const el = $(id);
    el.className = `alert alert-${type} show`;
    el.textContent = msg;
  }

  function clearAlert(id) {
    const el = $(id);
    el.className = 'alert';
    el.textContent = '';
  }

  function updateLastUpdatedCounter() {
    const sec = Math.max(0, Math.floor((Date.now() - lastDataUpdateAt) / 1000));
    $('last-updated').textContent = `Last updated ${sec}s ago`;
  }

  async function api(url, opts = {}) {
    const response = await fetch(url, {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) },
      ...opts,
    });

    let data = {};
    const ct = response.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      data = await response.json().catch(() => ({}));
    } else {
      const text = await response.text().catch(() => '');
      data = { raw: text };
    }

    return { ok: response.ok, status: response.status, data };
  }

  function renderAccessDenied() {
    document.body.innerHTML = `
      <div class="full-error">
        <div class="full-error-card">
          <h1>Access denied ‚Äî admin only</h1>
          <p>Your account is authenticated, but this page is restricted to admin access.</p>
        </div>
      </div>
    `;
  }

  async function checkAuthOnLoad() {
    const me = await api('/auth/me');
    if (me.status === 401) {
      window.location.href = '/?redirect=/admin.html';
      return false;
    }

    const usersProbe = await api('/admin/users');
    if (usersProbe.status === 403) {
      renderAccessDenied();
      return false;
    }

    if (!usersProbe.ok) {
      throw new Error(usersProbe.data?.error || 'Failed to load admin users');
    }

    users = Array.isArray(usersProbe.data) ? usersProbe.data : (usersProbe.data.users || []);
    return true;
  }

  async function pollHealth() {
    try {
      const response = await fetch('/health', { credentials: 'include' });
      const dot = $('health-dot');
      if (response.ok) {
        dot.classList.remove('offline');
        dot.classList.add('online');
        $('health-text').textContent = 'Health: online';
      } else {
        dot.classList.remove('online');
        dot.classList.add('offline');
        $('health-text').textContent = 'Health: degraded';
      }
    } catch {
      const dot = $('health-dot');
      dot.classList.remove('online');
      dot.classList.add('offline');
      $('health-text').textContent = 'Health: offline';
    }
  }

  async function loadStats() {
    const res = await api('/admin/stats');
    if (!res.ok) {
      $('stat-users').textContent = '?';
      $('stat-passkeys').textContent = '?';
      $('stat-sessions').textContent = '?';
      return;
    }

    const d = res.data || {};
    $('stat-users').textContent = d.totalUsers ?? d.users ?? 0;
    $('stat-passkeys').textContent = d.totalPasskeys ?? d.passkeys ?? 0;
    $('stat-sessions').textContent = d.activeSessions ?? d.sessions ?? 0;
    lastDataUpdateAt = Date.now();
  }

  async function loadUsers() {
    const btn = $('refresh-users');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Loading';
    clearAlert('users-alert');

    try {
      const res = await api('/admin/users');
      if (res.status === 403) {
        renderAccessDenied();
        return;
      }
      if (!res.ok) {
        throw new Error(res.data?.error || 'Failed to load users');
      }

      users = Array.isArray(res.data) ? res.data : (res.data.users || []);
      $('user-count').textContent = String(users.length);
      renderUsersTable();
      lastDataUpdateAt = Date.now();
    } catch (err) {
      $('users-body').innerHTML = '<tr><td colspan="7"><div class="empty">Could not load users.</div></td></tr>';
      $('user-count').textContent = '‚Äî';
      showAlert('users-alert', err.message || 'Could not load users.');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '‚Ü∫ Refresh';
    }
  }

  function renderUsersTable() {
    const body = $('users-body');

    if (!users.length) {
      body.innerHTML = '<tr><td colspan="7"><div class="empty">No users yet.</div></td></tr>';
      return;
    }

    const rows = [];

    for (const u of users) {
      const pkCount = Number(u.passkey_count ?? u.passkeyCount ?? 0);
      const isOpen = expanded.has(u.id);
      rows.push(`
        <tr class="user-row ${isOpen ? 'expanded' : ''}" data-user-id="${esc(u.id)}">
          <td>
            <button type="button" class="expand-btn ${isOpen ? 'open' : ''}" onclick="togglePasskeys('${esc(u.id)}', this)">
              <span class="arrow">‚ñ∂</span> Passkeys
            </button>
          </td>
          <td>
            <div class="user-cell">
              <div class="avatar">${esc(initials(u.username))}</div>
              <div class="username">${esc(u.username)}</div>
            </div>
          </td>
          <td>${esc(u.email || '‚Äî')}</td>
          <td>${formatDate(u.created_at)}</td>
          <td>${formatDate(u.last_login)}</td>
          <td>${pkCount > 0 ? `<span class="pk-badge">üîë ${pkCount}</span>` : '<span class="none-badge">None</span>'}</td>
          <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteUser('${esc(u.id)}', '${esc(u.username)}')">Delete user</button>
          </td>
        </tr>
        <tr class="sub-row">
          <td colspan="7">
            <div id="sub-${esc(u.id)}" class="sub-inner ${isOpen ? 'open' : ''}">
              <div class="passkeys-pane">
                <div class="passkeys-head">Passkeys for ${esc(u.username)}</div>
                <div id="pklist-${esc(u.id)}" class="pk-list">${isOpen ? 'Loading passkeys‚Ä¶' : ''}</div>
              </div>
            </div>
          </td>
        </tr>
      `);
    }

    body.innerHTML = rows.join('');

    for (const uid of expanded) {
      loadUserPasskeys(uid);
    }
  }

  async function togglePasskeys(userId, btn) {
    const panel = document.getElementById(`sub-${userId}`);
    const open = !panel.classList.contains('open');

    panel.classList.toggle('open', open);
    btn.classList.toggle('open', open);
    const parentRow = btn.closest('tr');
    if (parentRow) parentRow.classList.toggle('expanded', open);

    if (open) {
      expanded.add(userId);
      await loadUserPasskeys(userId);
    } else {
      expanded.delete(userId);
    }
  }

  function backupBadge(pk) {
    const synced = pk.backup_state === 1 || pk.backup_state === true || String(pk.backup_state).toLowerCase() === '1' || String(pk.backup_state).toLowerCase() === 'true';
    return synced
      ? '<span class="status-badge status-synced">‚óè synced</span>'
      : '<span class="status-badge status-notsynced">‚óè not synced</span>';
  }

  function passkeyItemHtml(userId, pk) {
    const name = pk.device_name || 'Unnamed device';
    const aaguid = (pk.aaguid || '').toLowerCase();
    const known = AAGUID_NAMES[aaguid];
    const aaguidTitle = known ? `title="${esc(known)}"` : 'title="Unknown authenticator"';
    const shortAaguid = aaguid || 'unknown';

    return `
      <div class="passkey-item">
        <div class="pk-device-wrap">
          <div class="pk-device-line">
            <input
              class="pk-name-input"
              id="pk-name-${esc(pk.id)}"
              type="text"
              value="${esc(name)}"
              maxlength="64"
              onkeydown="onPasskeyNameKey(event, '${esc(userId)}', '${esc(pk.id)}')"
            />
            <button type="button" class="btn btn-secondary btn-sm" onclick="renamePasskey('${esc(userId)}', '${esc(pk.id)}')">Save</button>
          </div>
          <div class="mono" ${aaguidTitle}>${esc(shortAaguid)}</div>
        </div>

        <div class="meta-col">
          <div class="pk-meta">Created: ${formatDate(pk.created_at)}</div>
          <div class="pk-meta">Last used: ${formatDate(pk.last_used)}</div>
        </div>

        <div>
          ${backupBadge(pk)}
        </div>

        <div style="display:flex; justify-content:flex-end;">
          <button type="button" class="btn btn-danger btn-sm" onclick="deletePasskey('${esc(userId)}', '${esc(pk.id)}', '${esc(name)}')">Delete</button>
        </div>
      </div>
    `;
  }

  async function loadUserPasskeys(userId) {
    const holder = document.getElementById(`pklist-${userId}`);
    if (!holder) return;

    holder.innerHTML = 'Loading passkeys‚Ä¶';
    try {
      const res = await api(`/admin/users/${userId}/passkeys`);
      if (!res.ok) {
        throw new Error(res.data?.error || 'Failed to load passkeys');
      }

      const list = Array.isArray(res.data) ? res.data : (res.data.passkeys || []);
      if (!list.length) {
        holder.innerHTML = '<div style="color:var(--muted2); font-size:12px;">No passkeys enrolled.</div>';
        return;
      }

      holder.innerHTML = list.map((pk) => passkeyItemHtml(userId, pk)).join('');
    } catch (err) {
      holder.innerHTML = `<div style="color:#fca5a5; font-size:12px;">${esc(err.message || 'Failed')}</div>`;
    }
  }

  async function deleteUser(userId, username) {
    if (!confirm(`Delete user "${username}"?\n\nThis will permanently remove their account and passkeys.`)) return;

    const res = await api(`/admin/users/${userId}`, { method: 'DELETE' });
    if (!res.ok) {
      showAlert('users-alert', res.data?.error || 'Failed to delete user.');
      return;
    }

    users = users.filter((u) => u.id !== userId);
    expanded.delete(userId);
    renderUsersTable();
    $('user-count').textContent = String(users.length);
    showAlert('users-alert', 'User deleted.', 'success');
    await loadStats();
  }

  async function deletePasskey(userId, passkeyId, name) {
    if (!confirm(`Delete passkey "${name}"?`)) return;

    const res = await api(`/admin/users/${userId}/passkeys/${passkeyId}`, { method: 'DELETE' });
    if (!res.ok) {
      alert(res.data?.error || 'Failed to delete passkey.');
      return;
    }

    await loadUserPasskeys(userId);
    await loadUsers();
    await loadStats();
  }

  async function renamePasskey(userId, passkeyId) {
    const input = document.getElementById(`pk-name-${passkeyId}`);
    if (!input) return;

    const deviceName = input.value.trim();
    if (!deviceName) {
      alert('Device name cannot be empty.');
      return;
    }

    const candidates = [
      { url: `/admin/users/${userId}/passkeys/${passkeyId}`, method: 'PATCH', body: { device_name: deviceName, deviceName } },
      { url: `/admin/users/${userId}/passkeys/${passkeyId}/rename`, method: 'PATCH', body: { device_name: deviceName, deviceName } },
      { url: `/auth/passkey/${passkeyId}/rename`, method: 'PATCH', body: { deviceName } },
    ];

    let success = false;
    for (const c of candidates) {
      try {
        const res = await api(c.url, { method: c.method, body: JSON.stringify(c.body) });
        if (res.ok) {
          success = true;
          break;
        }
      } catch (_) {}
    }

    if (!success) {
      alert('Could not update device name. Rename endpoint may not be available on this server.');
      return;
    }

    await loadUserPasskeys(userId);
    await loadStats();
  }

  function onPasskeyNameKey(event, userId, passkeyId) {
    if (event.key === 'Enter') {
      event.preventDefault();
      renamePasskey(userId, passkeyId);
    }
  }

  async function addUser(event) {
    event.preventDefault();
    clearAlert('add-alert');

    const submit = $('add-submit');
    submit.disabled = true;
    submit.innerHTML = '<span class="spinner"></span> Creating';

    try {
      const payload = {
        username: $('add-username').value.trim(),
        email: $('add-email').value.trim(),
        password: $('add-password').value,
      };

      const res = await api('/admin/users', { method: 'POST', body: JSON.stringify(payload) });
      if (!res.ok) {
        throw new Error(res.data?.error || 'Failed to add user');
      }

      $('add-form').reset();
      showAlert('add-alert', 'User created successfully.', 'success');
      await loadUsers();
      await loadStats();
    } catch (err) {
      showAlert('add-alert', err.message || 'Failed to add user.');
    } finally {
      submit.disabled = false;
      submit.innerHTML = 'Add User';
    }
  }

  async function init() {
    try {
      const ok = await checkAuthOnLoad();
      if (!ok) return;

      $('app').style.display = '';
      $('add-form').addEventListener('submit', addUser);
      $('refresh-users').addEventListener('click', loadUsers);

      $('user-count').textContent = String(users.length);
      renderUsersTable();

      await Promise.all([loadStats(), pollHealth(), loadUsers()]);
      updateLastUpdatedCounter();

      setInterval(pollHealth, 30000);
      setInterval(updateLastUpdatedCounter, 1000);
    } catch (err) {
      document.body.innerHTML = `
        <div class="full-error">
          <div class="full-error-card">
            <h1>Admin panel failed to load</h1>
            <p>${esc(err.message || 'Unexpected error')}</p>
          </div>
        </div>
      `;
    }
  }

  window.togglePasskeys = togglePasskeys;
  window.deleteUser = deleteUser;
  window.deletePasskey = deletePasskey;
  window.renamePasskey = renamePasskey;
  window.onPasskeyNameKey = onPasskeyNameKey;

  init();
</script>
</body>
</html>
